package main

import (
	"context"
	"fmt"
	"log"
	"time"

	"github.com/muriloAvlis/USAP/pkg/pb"
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
)

const srsRanRFDef string = "60304F52414E2D4532534D2D4B504D000018312E332E362E312E342E312E35333134382E312E322E322E3205004B504D204D6F6E69746F720001010700506572696F646963205265706F7274010110010109004532204E6F6465204D6561737572656D656E740101000F004043514901E04452422E416972496644656C6179556C03604452422E5061636B65745375636365737352617465556C674E42557501A04452422E526C6344656C6179556C02C04452422E526C635061636B657444726F7052617465446C02004452422E526C6353647544656C6179446C03804452422E526C635364755472616E736D6974746564566F6C756D65444C03804452422E526C635364755472616E736D6974746564566F6C756D65554C01404452422E5545546870446C01404452422E5545546870556C01A05252552E507262417661696C446C01A05252552E507262417661696C556C01605252552E507262546F74446C01605252552E507262546F74556C0060525352500060525352510101010100010211004532204E6F6465204D6561737572656D656E7420666F7220612073696E676C652055450102000F004043514901E04452422E416972496644656C6179556C03604452422E5061636B65745375636365737352617465556C674E42557501A04452422E526C6344656C6179556C02C04452422E526C635061636B657444726F7052617465446C02004452422E526C6353647544656C6179446C03804452422E526C635364755472616E736D6974746564566F6C756D65444C03804452422E526C635364755472616E736D6974746564566F6C756D65554C01404452422E5545546870446C01404452422E5545546870556C01A05252552E507262417661696C446C01A05252552E507262417661696C556C01605252552E507262546F74446C01605252552E507262546F74556C006052535250006052535251010101010001031600436F6E646974696F6E2D62617365642C2055452D6C6576656C204532204E6F6465204D6561737572656D656E740103000F004043514901E04452422E416972496644656C6179556C03604452422E5061636B65745375636365737352617465556C674E42557501A04452422E526C6344656C6179556C02C04452422E526C635061636B657444726F7052617465446C02004452422E526C6353647544656C6179446C03804452422E526C635364755472616E736D6974746564566F6C756D65444C03804452422E526C635364755472616E736D6974746564566F6C756D65554C01404452422E5545546870446C01404452422E5545546870556C01A05252552E507262417661696C446C01A05252552E507262417661696C556C01605252552E507262546F74446C01605252552E507262546F74556C006052535250006052535251010101020001041580436F6D6D6F6E20436F6E646974696F6E2D62617365642C2055452D6C6576656C204D6561737572656D656E740104000F004043514901E04452422E416972496644656C6179556C03604452422E5061636B65745375636365737352617465556C674E42557501A04452422E526C6344656C6179556C02C04452422E526C635061636B657444726F7052617465446C02004452422E526C6353647544656C6179446C03804452422E526C635364755472616E736D6974746564566F6C756D65444C03804452422E526C635364755472616E736D6974746564566F6C756D65554C01404452422E5545546870446C01404452422E5545546870556C01A05252552E507262417661696C446C01A05252552E507262417661696C556C01605252552E507262546F74446C01605252552E507262546F74556C0060525352500060525352510101010300010511804532204E6F6465204D6561737572656D656E7420666F72206D756C7469706C65205545730105000F004043514901E04452422E416972496644656C6179556C03604452422E5061636B65745375636365737352617465556C674E42557501A04452422E526C6344656C6179556C02C04452422E526C635061636B657444726F7052617465446C02004452422E526C6353647544656C6179446C03804452422E526C635364755472616E736D6974746564566F6C756D65444C03804452422E526C635364755472616E736D6974746564566F6C756D65554C01404452422E5545546870446C01404452422E5545546870556C01A05252552E507262417661696C446C01A05252552E507262417661696C556C01605252552E507262546F74446C01605252552E507262546F74556C00605253525000605253525101010103"

// E2SM-KPM spec: 7.4.1 REPORT Service Style Type (1-5)
func DecodeActFmtTypebyReportStyle(ranFunctionDefinition string, ricReportStyle uint32) []string {
	// create a new gRPC connection
	conn, err := grpc.NewClient("localhost:5051", grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf("Failed to connect: %s", err.Error())
	}

	defer conn.Close()

	client := pb.NewRanFuncDefDecoderClient(conn)

	// timeout ctx
	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()

	// Request
	request := &pb.MeasListByReportStyleRequest{
		EncodedRanFunctionDefinition: ranFunctionDefinition,
		ReportStyleType:              ricReportStyle,
	}

	// Measure time
	startTime := time.Now()

	// call RPC method
	response, err := client.GetMeasListbyRicReportStyle(ctx, request)
	if err != nil {
		log.Fatalf("Error to call gRPC method: %s", err.Error())
	}

	// Measure time
	duration := time.Since(startTime)

	// Print the time taken
	fmt.Printf("gRPC call took %v\n", duration)

	return response.MeasList
}

func EncodeEventTriggerDefinitionFormat1(reportingPeriod uint64) []int64 {
	// create a new gRPC connection
	conn, err := grpc.NewClient("localhost:5051", grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf("Failed to connect: %s", err.Error())
	}

	defer conn.Close()

	client := pb.NewEventTriggerFmtEncoderClient(conn)

	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()

	request := &pb.EventTriggerDefFmt1Resquest{
		ReportingPeriod: reportingPeriod,
	}

	// Measure time
	startTime := time.Now()

	// call RPC method
	response, err := client.EncodeEventTriggerFmt1(ctx, request)
	if err != nil {
		log.Fatalf("Error to call gRPC method: %s", err.Error())
	}

	// Measure time
	duration := time.Since(startTime)

	// Print the time taken
	fmt.Printf("gRPC call took %v\n", duration)

	return response.EncodedEventTriggerDefinition
}

func EncodeActionDefinitionFmt4(measNameList []string, granularityPeriod uint64) []int64 {
	// create a new gRPC connection
	conn, err := grpc.NewClient("localhost:5051", grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf("Failed to connect: %s", err.Error())
	}

	defer conn.Close()

	client := pb.NewActDefEncoderClient(conn)

	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()

	request := &pb.ActDefFmt4Request{
		MeasNameList:      measNameList,
		GranularityPeriod: granularityPeriod,
	}

	// Measure time
	startTime := time.Now()

	// call RPC method
	response, err := client.EncodeActionDefinitionFmt4(ctx, request)
	if err != nil {
		log.Fatalf("Error to call gRPC method: %s", err.Error())
	}

	// Measure time
	duration := time.Since(startTime)

	// Print the time taken
	fmt.Printf("gRPC call took %v\n", duration)

	return response.EncodedActionDefinition
}

func main() {
	// RAN Function Definition Decoder
	measNameList := DecodeActFmtTypebyReportStyle(srsRanRFDef, 4)
	fmt.Println(measNameList)

	// Event Trigger Format Encoder
	reportingPeriod := 10000
	encodedEvTriggerDefFmt1 := EncodeEventTriggerDefinitionFormat1(reportingPeriod)
	fmt.Printf("Event Trigger Definition Format 1 encoded: %v\n", encodedEvTriggerDefFmt1)

	// Action definition format 4 encoder
	// encodedActDefFmt4 := EncodeActionDefinitionFmt4(measNameList, 1000)
	// fmt.Println(encodedActDefFmt4)
}
